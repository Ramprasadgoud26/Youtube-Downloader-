<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTDownloader - Download YouTube Videos & Audio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff0000;
            --primary-dark: #cc0000;
            --secondary: #282828;
            --accent: #3498db;
            --light: #f5f5f5;
            --dark: #121212;
            --success: #2ecc71;
            --warning: #f39c12;
            --gray: #95a5a6;
            --card-bg: #ffffff;
            --text-dark: #333333;
            --text-light: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
        }

        .logo h1 {
            font-size: 2.2rem;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 20px;
        }

        .search-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .search-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            display: flex;
            margin-bottom: 1.5rem;
            gap: 10px;
        }

        .search-input, .url-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--gray);
            border-radius: 5px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus, .url-input:focus {
            border-color: var(--accent);
        }

        .search-btn, .fetch-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .search-btn:hover, .fetch-btn:hover {
            background-color: #2980b9;
        }

        .search-results {
            display: none;
            margin-top: 1.5rem;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
        }

        .results-count {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .clear-results {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .video-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .video-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            position: relative;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .video-info {
            padding: 1rem;
        }

        .video-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-author {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .video-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .video-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            display: none;
        }

        .thumbnail {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .video-title-preview {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .video-duration-preview, .video-views-preview, .video-author-preview {
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            display: none;
        }

        .option-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            border-left: 4px solid var(--accent);
        }

        .option-card:hover {
            transform: translateY(-3px);
        }

        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .option-icon {
            font-size: 1.8rem;
            margin-right: 15px;
            color: var(--accent);
        }

        .option-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .quality-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }

        .quality-btn {
            background-color: var(--light);
            border: 1px solid var(--gray);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .quality-btn:hover, .quality-btn.active {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .download-btn {
            display: block;
            width: 100%;
            background-color: var(--success);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            margin-top: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .download-btn:hover {
            background-color: #27ae60;
        }

        .download-btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            position: relative;
        }

        .progress {
            width: 0%;
            height: 20px;
            background-color: var(--success);
            border-radius: 5px;
            transition: width 0.3s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-dark);
            font-weight: bold;
        }

        .feature-section {
            margin-top: 3rem;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
        }

        .feature {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .feature i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .feature h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        footer {
            background-color: var(--secondary);
            color: var(--text-light);
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .disclaimer {
            background-color: var(--warning);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .selected-video {
            border: 3px solid var(--success);
            background-color: rgba(46, 204, 113, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .search-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 0.8rem 1rem;
                border-bottom: none;
                border-right: 3px solid transparent;
            }
            
            .tab-btn.active {
                border-right-color: var(--primary);
                border-bottom-color: transparent;
            }
            
            .input-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input, .url-input {
                border-radius: 5px;
            }
            
            .search-btn, .fetch-btn {
                border-radius: 5px;
                padding: 15px;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
            
            .search-results-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fab fa-youtube"></i>
            <h1>YTDownloader</h1>
        </div>
        <p>Search and download YouTube videos and audio in multiple formats and quality</p>
    </header>

    <div class="container">
        <div class="search-section">
            <div class="search-tabs">
                <button class="tab-btn active" data-tab="search">
                    <i class="fas fa-search"></i> Search Videos
                </button>
                <button class="tab-btn" data-tab="url">
                    <i class="fas fa-link"></i> Paste URL
                </button>
            </div>

            <!-- Search Tab -->
            <div class="tab-content active" id="search-tab">
                <h2>Search YouTube Videos</h2>
                <p>Enter keywords to search for videos on YouTube</p>
                
                <div class="input-group">
                    <input type="text" class="search-input" id="searchQuery" placeholder="Search for videos...">
                    <button class="search-btn" id="searchBtn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>

                <div class="search-results" id="searchResults">
                    <div class="search-results-header">
                        <div class="results-count" id="resultsCount"></div>
                        <button class="clear-results" id="clearResults">Clear Results</button>
                    </div>
                    <div class="video-grid" id="videoGrid"></div>
                </div>
            </div>

            <!-- URL Tab -->
            <div class="tab-content" id="url-tab">
                <h2>Download from URL</h2>
                <p>Enter the URL of the YouTube video you want to download</p>
                
                <div class="input-group">
                    <input type="text" class="url-input" id="videoUrl" placeholder="Paste YouTube URL here...">
                    <button class="fetch-btn" id="fetchBtn">
                        <i class="fas fa-download"></i> Fetch Video
                    </button>
                </div>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>

        <div class="video-preview" id="videoPreview">
            <img src="" alt="Video thumbnail" class="thumbnail" id="videoThumbnail">
            <h3 class="video-title-preview" id="videoTitle"></h3>
            <p class="video-duration-preview" id="videoDuration"></p>
            <p class="video-views-preview" id="videoViews"></p>
            <p class="video-author-preview" id="videoAuthor"></p>
        </div>

        <div class="download-options" id="downloadOptions">
            <div class="option-card">
                <div class="option-header">
                    <i class="fas fa-film option-icon"></i>
                    <h3 class="option-title">Video Downloads</h3>
                </div>
                <p>Select from various video quality options</p>
                <div class="quality-options">
                    <button class="quality-btn" data-quality="144p">144p</button>
                    <button class="quality-btn" data-quality="240p">240p</button>
                    <button class="quality-btn" data-quality="360p">360p</button>
                    <button class="quality-btn" data-quality="480p">480p</button>
                    <button class="quality-btn" data-quality="720p">720p HD</button>
                    <button class="quality-btn" data-quality="1080p">1080p FHD</button>
                    <button class="quality-btn" data-quality="highest">Highest Quality</button>
                </div>
                <button class="download-btn video-download"><i class="fas fa-download"></i> Download Video</button>
            </div>
            
            <div class="option-card">
                <div class="option-header">
                    <i class="fas fa-music option-icon"></i>
                    <h3 class="option-title">Audio Downloads</h3>
                </div>
                <p>Download audio only in various formats</p>
                <div class="quality-options">
                    <button class="quality-btn" data-quality="128kbps">MP3 128kbps</button>
                    <button class="quality-btn" data-quality="192kbps">MP3 192kbps</button>
                    <button class="quality-btn" data-quality="256kbps">MP3 256kbps</button>
                    <button class="quality-btn" data-quality="320kbps">MP3 320kbps</button>
                </div>
                <button class="download-btn audio-download"><i class="fas fa-download"></i> Download Audio</button>
            </div>
            
            <div class="option-card">
                <div class="option-header">
                    <i class="fas fa-cog option-icon"></i>
                    <h3 class="option-title">Advanced Options</h3>
                </div>
                <p>Customize your download experience</p>
                <div class="quality-options">
                    <button class="quality-btn">Subtitles</button>
                    <button class="quality-btn">Custom Format</button>
                    <button class="quality-btn">Playlist</button>
                    <button class="quality-btn">Trim Video</button>
                </div>
                <button class="download-btn"><i class="fas fa-download"></i> Custom Download</button>
            </div>
        </div>

        <div class="feature-section">
            <h2 class="section-title">Why Choose YTDownloader?</h2>
            <div class="features">
                <div class="feature">
                    <i class="fas fa-search"></i>
                    <h3>Smart Search</h3>
                    <p>Search and discover videos directly from our interface</p>
                </div>
                <div class="feature">
                    <i class="fas fa-bolt"></i>
                    <h3>Fast Downloads</h3>
                    <p>Download your videos and audio at high speeds</p>
                </div>
                <div class="feature">
                    <i class="fas fa-lock"></i>
                    <h3>Secure</h3>
                    <p>No data storage, your privacy is protected</p>
                </div>
                <div class="feature">
                    <i class="fas fa-infinity"></i>
                    <h3>Unlimited</h3>
                    <p>No daily limits on downloads</p>
                </div>
                <div class="feature">
                    <i class="fas fa-thumbs-up"></i>
                    <h3>High Quality</h3>
                    <p>Get the best available quality for every video</p>
                </div>
                <div class="feature">
                    <i class="fas fa-mobile-alt"></i>
                    <h3>Responsive</h3>
                    <p>Works perfectly on desktop, tablet, and mobile devices</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>YTDownloader &copy; 2023 - The Ultimate YouTube Video & Audio Downloader</p>
            <div class="disclaimer">
                Disclaimer: This service is intended for personal use only. Please ensure you comply with YouTube's Terms of Service when downloading content.
            </div>
            <p>Contact: support@ytdownloader.com | FAQ | Privacy Policy</p>
        </div>
    </footer>

    <script>
        // DOM Elements
        const searchBtn = document.getElementById('searchBtn');
        const fetchBtn = document.getElementById('fetchBtn');
        const searchQuery = document.getElementById('searchQuery');
        const videoUrl = document.getElementById('videoUrl');
        const searchResults = document.getElementById('searchResults');
        const videoGrid = document.getElementById('videoGrid');
        const resultsCount = document.getElementById('resultsCount');
        const clearResults = document.getElementById('clearResults');
        const videoPreview = document.getElementById('videoPreview');
        const videoThumbnail = document.getElementById('videoThumbnail');
        const videoTitle = document.getElementById('videoTitle');
        const videoDuration = document.getElementById('videoDuration');
        const videoViews = document.getElementById('videoViews');
        const videoAuthor = document.getElementById('videoAuthor');
        const downloadOptions = document.getElementById('downloadOptions');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const progressText = document.getElementById('progressText');

        // Global variables
        let currentVideoId = null;
        let selectedQuality = null;
        let selectedType = null;
        let currentVideoUrl = null;

        // Tab switching functionality
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // Remove active class from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                btn.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Clear previous results when switching tabs
                clearSearchResults();
                clearVideoPreview();
            });
        });

        // Function to extract video ID from YouTube URL
        function getVideoId(url) {
            try {
                const yt = new URL(url);
                
                // Handle youtu.be URLs
                if (yt.hostname === 'youtu.be') {
                    return yt.pathname.slice(1);
                }
                
                // Handle regular YouTube URLs
                if (yt.hostname.includes('youtube.com')) {
                    return yt.searchParams.get('v');
                }
                
                return null;
            } catch (error) {
                console.error('Error extracting video ID:', error);
                return null;
            }
        }

        // Search functionality
        searchBtn.addEventListener('click', async () => {
            const query = searchQuery.value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            try {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<div class="loading"></div> Searching...';
                
                clearSearchResults();
                
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&max_results=20`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Search error: ' + data.error);
                    return;
                }
                
                displaySearchResults(data.videos, query);
                
            } catch (error) {
                alert('Error searching videos: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            }
        });

        // Display search results
        function displaySearchResults(videos, query) {
            if (videos.length === 0) {
                videoGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No videos found</h3>
                        <p>Try different keywords or check your spelling</p>
                    </div>
                `;
                searchResults.style.display = 'block';
                resultsCount.textContent = 'No results found';
                return;
            }

            resultsCount.textContent = `Found ${videos.length} videos for "${query}"`;
            searchResults.style.display = 'block';
            
            videoGrid.innerHTML = videos.map(video => `
                <div class="video-card" data-video-url="${video.url}" data-video-id="${video.id}">
                    <div style="position: relative;">
                        <img src="${video.thumbnail}" alt="${video.title}" class="video-thumbnail">
                        <div class="video-duration">${video.duration_formatted}</div>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${video.title}</h3>
                        <p class="video-author">${video.author}</p>
                        <div class="video-stats">
                            <span>${video.views_formatted} views</span>
                            <span><i class="fas fa-download"></i> Select to download</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add click handlers to video cards
            document.querySelectorAll('.video-card').forEach(card => {
                card.addEventListener('click', () => selectVideoFromSearch(card));
            });

            // Smooth scroll to results
            searchResults.scrollIntoView({ behavior: 'smooth' });
        }

        // Select video from search results
        function selectVideoFromSearch(card) {
            // Remove previous selection
            document.querySelectorAll('.video-card').forEach(c => c.classList.remove('selected-video'));
            
            // Add selection to clicked card
            card.classList.add('selected-video');
            
            const videoUrl = card.dataset.videoUrl;
            const videoId = card.dataset.videoId;
            
            // Set the URL and fetch video info
            currentVideoUrl = videoUrl;
            currentVideoId = videoId;
            
            // Fetch detailed video info
            fetchVideoInfo(videoUrl);
        }

        // Fetch video info
        async function fetchVideoInfo(url) {
            try {
                const response = await fetch(`/api/video_info?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Display video info
                videoThumbnail.src = data.thumbnail;
                videoTitle.textContent = data.title;
                videoDuration.textContent = `Duration: ${data.duration_formatted}`;
                videoViews.textContent = `Views: ${data.views_formatted}`;
                videoAuthor.textContent = `Channel: ${data.author}`;
                
                videoPreview.style.display = 'flex';
                downloadOptions.style.display = 'grid';
                
                // Get video ID for progress tracking
                currentVideoId = getVideoId(url);
                
                // Smooth scroll to download options
                downloadOptions.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert('Error fetching video information: ' + error.message);
            }
        }

        // Fetch video from URL
        fetchBtn.addEventListener('click', async () => {
            if (videoUrl.value.trim() === '') {
                alert('Please enter a YouTube URL');
                return;
            }

            try {
                fetchBtn.disabled = true;
                fetchBtn.innerHTML = '<div class="loading"></div> Fetching...';
                
                currentVideoUrl = videoUrl.value;
                await fetchVideoInfo(videoUrl.value);
                
            } catch (error) {
                alert('Error fetching video information: ' + error.message);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-download"></i> Fetch Video';
            }
        });

        // Clear search results
        function clearSearchResults() {
            searchResults.style.display = 'none';
            videoGrid.innerHTML = '';
            resultsCount.textContent = '';
        }

        // Clear video preview
        function clearVideoPreview() {
            videoPreview.style.display = 'none';
            downloadOptions.style.display = 'none';
            progressBar.style.display = 'none';
        }

        // Clear results button
        clearResults.addEventListener('click', () => {
            clearSearchResults();
            clearVideoPreview();
            searchQuery.value = '';
        });

        // Quality button selection
        const qualityBtns = document.querySelectorAll('.quality-btn');
        qualityBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons in the same group
                const siblings = Array.from(btn.parentElement.children);
                siblings.forEach(sibling => sibling.classList.remove('active'));
                
                // Add active class to clicked button
                btn.classList.add('active');
                selectedQuality = btn.dataset.quality;
            });
        });

        // Download buttons with improved error handling
        const downloadBtns = document.querySelectorAll('.download-btn');
        downloadBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!currentVideoUrl) {
                    alert('Please select a video first');
                    return;
                }
                
                const card = btn.closest('.option-card');
                const activeQuality = card.querySelector('.quality-btn.active');
                
                if (!activeQuality) {
                    alert('Please select a quality option first');
                    return;
                }
                
                // Determine if it's audio or video download
                const isAudioDownload = btn.classList.contains('audio-download');
                
                try {
                    // Disable download button and show loading state
                    btn.disabled = true;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<div class="loading"></div> Starting Download...';
                    
                    // Show progress bar
                    progressBar.style.display = 'block';
                    progress.style.width = '0%';
                    progressText.textContent = '0%';
                    
                    // Start download
                    const response = await fetch('/api/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: currentVideoUrl,
                            quality: activeQuality.dataset.quality,
                            audio_only: isAudioDownload
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert('Error: ' + data.error);
                        progressBar.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        return;
                    }
                    
                    // Start polling for progress
                    const videoId = data.video_id;
                    let progressInterval = setInterval(async () => {
                        try {
                            const progressResponse = await fetch(`/api/progress/${videoId}`);
                            const progressData = await progressResponse.json();
                            
                            if (progressData.status === 'error') {
                                clearInterval(progressInterval);
                                alert('Download failed: ' + (progressData.error || 'Unknown error'));
                                progressBar.style.display = 'none';
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                                return;
                            }
                            
                            if (progressData.progress !== undefined) {
                                const progressPercent = Math.round(progressData.progress);
                                progress.style.width = `${progressPercent}%`;
                                progressText.textContent = `${progressPercent}%`;
                                
                                // Update button text based on status
                                if (progressData.status === 'downloading') {
                                    btn.innerHTML = `<i class="fas fa-download"></i> Downloading... ${progressPercent}%`;
                                } else if (progressData.status === 'processing') {
                                    btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processing...';
                                }
                                
                                if (progressData.status === 'completed') {
                                    clearInterval(progressInterval);
                                    progressText.textContent = 'Download Complete!';
                                    btn.innerHTML = '<i class="fas fa-check"></i> Download Complete!';
                                    
                                    // Wait a bit before attempting download
                                    setTimeout(async () => {
                                        try {
                                            // Try to download the file
                                            const downloadResponse = await fetch(`/api/download_file/${videoId}`);
                                            
                                            if (downloadResponse.ok) {
                                                // Create a blob and download it
                                                const blob = await downloadResponse.blob();
                                                const downloadUrl = window.URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.style.display = 'none';
                                                a.href = downloadUrl;
                                                
                                                // Try to get filename from headers
                                                const contentDisposition = downloadResponse.headers.get('Content-Disposition');
                                                let filename = 'download';
                                                if (contentDisposition) {
                                                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                                    if (filenameMatch && filenameMatch[1]) {
                                                        filename = filenameMatch[1].replace(/['"]/g, '');
                                                    }
                                                }
                                                a.download = filename;
                                                
                                                document.body.appendChild(a);
                                                a.click();
                                                window.URL.revokeObjectURL(downloadUrl);
                                                document.body.removeChild(a);
                                            } else {
                                                // If response is not ok, it might be JSON error
                                                const errorData = await downloadResponse.json();
                                                alert('Download failed: ' + errorData.error);
                                            }
                                        } catch (downloadError) {
                                            console.error('Download error:', downloadError);
                                            // Fallback to direct link
                                            window.location.href = `/api/download_file/${videoId}`;
                                        }
                                        
                                        progressBar.style.display = 'none';
                                        btn.disabled = false;
                                        btn.innerHTML = originalText;
                                    }, 2000);
                                }
                            }
                        } catch (error) {
                            console.error('Error checking progress:', error);
                            clearInterval(progressInterval);
                            progressBar.style.display = 'none';
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            alert('Error checking download progress');
                        }
                    }, 1000);
                    
                    // Set a timeout to prevent infinite polling
                    setTimeout(() => {
                        if (progressInterval) {
                            clearInterval(progressInterval);
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            progressBar.style.display = 'none';
                            alert('Download timeout - please try again');
                        }
                    }, 300000); // 5 minutes timeout
                    
                } catch (error) {
                    alert('Error starting download: ' + error.message);
                    progressBar.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        });

        // Enter key support for inputs
        searchQuery.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });

        videoUrl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchBtn.click();
            }
        });

        // Example suggestions
        searchQuery.addEventListener('focus', () => {
            if (searchQuery.value === '') {
                searchQuery.placeholder = 'Example: "music videos 2023", "how to cook pasta"';
            }
        });

        searchQuery.addEventListener('blur', () => {
            searchQuery.placeholder = 'Search for videos...';
        });

        videoUrl.addEventListener('focus', () => {
            if (videoUrl.value === '') {
                videoUrl.placeholder = 'Example: https://www.youtube.com/watch?v=dQw4w9WgXcQ';
            }
        });

        videoUrl.addEventListener('blur', () => {
            videoUrl.placeholder = 'Paste YouTube URL here...';
        });

        // Auto-detect and validate YouTube URLs
        videoUrl.addEventListener('input', (e) => {
            const url = e.target.value;
            const videoId = getVideoId(url);
            
            if (url && !videoId) {
                e.target.style.borderColor = '#e74c3c';
            } else if (videoId) {
                e.target.style.borderColor = '#27ae60';
            } else {
                e.target.style.borderColor = '#95a5a6';
            }
        });
    </script>
</body>
</html>